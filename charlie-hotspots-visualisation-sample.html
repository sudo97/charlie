<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Charlie - Git History Visualization</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        margin-top: 0;
      }
    </style>

    <!-- TODO: Insert this with a template engine -->
    <script id="data" type="application/json">
      {
        "name": "Charlie",
        "children": [
          {
            "name": "src",
            "children": [
              {
                "name": "tree-data.ts",
                "complexity": 53,
                "revisions": 4
              },
              {
                "name": "tree-data.test.ts",
                "complexity": 94,
                "revisions": 2
              },
              {
                "name": "git-log.ts",
                "complexity": 164,
                "revisions": 1
              },
              {
                "name": "hotspots.test.ts",
                "complexity": 43,
                "revisions": 3
              },
              {
                "name": "hotspots.ts",
                "complexity": 26,
                "revisions": 3
              },
              {
                "name": "index.ts",
                "complexity": 34,
                "revisions": 2
              },
              {
                "name": "revisions.test.ts",
                "complexity": 32,
                "revisions": 1
              },
              {
                "name": "index.test.ts",
                "complexity": 15,
                "revisions": 2
              },
              {
                "name": "visual-complexity.test.ts",
                "complexity": 25,
                "revisions": 1
              },
              {
                "name": "revisions.ts",
                "complexity": 20,
                "revisions": 1
              },
              {
                "name": "visual-complexity.ts",
                "complexity": 19,
                "revisions": 1
              }
            ]
          },
          {
            "name": "tsconfig.json",
            "complexity": 63,
            "revisions": 2
          },
          {
            "name": "vitest.config.ts",
            "complexity": 38,
            "revisions": 2
          },
          {
            "name": ".gitignore",
            "complexity": 56,
            "revisions": 1
          },
          {
            "name": "eslint.config.js",
            "complexity": 26,
            "revisions": 1
          }
        ]
      }
      
    </script>

    <script type="module">
      import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

      const dataElement = document.getElementById("data");
      const data = JSON.parse(dataElement.textContent);

      // Set up dimensions
      const width = 800;
      const height = 600;

      // Create SVG
      const svg = d3
        .create("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", [0, 0, width, height])
        .style("max-width", "100%")
        .style("height", "auto");

      // Create hierarchy
      const root = d3.hierarchy(data).sum((d) => d.revisions || 0); // Size based on revisions only

      // Create pack layout
      const pack = d3.pack().size([width, height]).padding(3);

      // Apply pack layout
      pack(root);

      // Find min and max complexity for color scale
      const allNodes = root.descendants();
      const complexityValues = allNodes
        .filter((d) => d.data.complexity !== undefined)
        .map((d) => d.data.complexity);
      const minComplexity = Math.min(...complexityValues);
      const maxComplexity = Math.max(...complexityValues);

      // Create color scale based on complexity (green to red)
      const color = d3
        .scaleSequential(d3.interpolateRdYlGn)
        .domain([maxComplexity, minComplexity]); // Reversed domain: high complexity = red, low = green

      // Add circles
      const circles = svg
        .selectAll("circle")
        .data(root.descendants())
        .join("circle")
        .attr("cx", (d) => d.x)
        .attr("cy", (d) => d.y)
        .attr("r", (d) => d.r)
        .attr("fill", (d) => {
          // Use complexity for color, fallback to light gray for nodes without complexity (like Root, folder1)
          if (d.data.complexity !== undefined) {
            return color(d.data.complexity);
          }
          return "#e8e8e8"; // Light gray for containers
        })
        .attr("stroke", "#fff")
        .attr("stroke-width", 2)
        .style("opacity", 0.8);

      // Add text labels
      const labels = svg
        .selectAll("text")
        .data(root.descendants())
        .join("text")
        .attr("x", (d) => d.x)
        .attr("y", (d) => d.y - d.r + 15)
        .attr("text-anchor", "middle")
        .attr("dominant-baseline", "hanging")
        .style("font-size", (d) => Math.min(d.r / 3, 14) + "px")
        .style("font-weight", "bold")
        .style("fill", "#333")
        .style("pointer-events", "none")
        .text((d) => d.data.name);

      // Add the SVG to the container
      const container = document.getElementById("visualization");
      container.appendChild(svg.node());
    </script>
  </head>
  <body>
    <div class="container">
      <h1>Git History Visualization</h1>
      <div id="visualization">
        <!-- D3 visualization will be inserted here -->
      </div>
    </div>

    <!-- D3 and data will be added here later -->
  </body>
</html>
